<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#02b1e0"><meta name="generator" content="Hexo 6.2.0">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo/favicon.ico" color="#02b1e0">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="该文档主要是《eBPF 核心技术与实战》课程的笔记以及一些扩展。其中代码在ebpf-learn-code仓库中，编译环境都在 Docker 镜像中，也具备 cilium-ebpf 的编译环境。  什么是eBPFeBPF 是从 BPF 技术扩展而来的，得益于 BPF 的设计:  内核态引入一个新的虚拟机(执行引擎)，所有指令都在内核虚拟机中运行； 用户态使用 BPF 字节码来定义过滤表达式，然后传">
<meta property="og:type" content="article">
<meta property="og:title" content="eBPF 原理及其应用">
<meta property="og:url" content="http://example.com/2022/12/06/eBPF/getting-start-with-eBPF/index.html">
<meta property="og:site_name" content="champly">
<meta property="og:description" content="该文档主要是《eBPF 核心技术与实战》课程的笔记以及一些扩展。其中代码在ebpf-learn-code仓库中，编译环境都在 Docker 镜像中，也具备 cilium-ebpf 的编译环境。  什么是eBPFeBPF 是从 BPF 技术扩展而来的，得益于 BPF 的设计:  内核态引入一个新的虚拟机(执行引擎)，所有指令都在内核虚拟机中运行； 用户态使用 BPF 字节码来定义过滤表达式，然后传">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/eBPF/getting-start-with-eBPF/implementation-process.jpg">
<meta property="og:image" content="http://example.com/images/eBPF/getting-start-with-eBPF/verification-architecture.png">
<meta property="og:image" content="http://example.com/images/eBPF/getting-start-with-eBPF/bpf-map.jpg">
<meta property="og:image" content="http://example.com/images/eBPF/getting-start-with-eBPF/tc-process.jpg">
<meta property="og:image" content="http://example.com/images/eBPF/getting-start-with-eBPF/bpftrace-internals.png">
<meta property="article:published_time" content="2022-12-06T02:08:36.000Z">
<meta property="article:modified_time" content="2023-05-11T05:53:11.746Z">
<meta property="article:author" content="champly">
<meta property="article:tag" content="eBPF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/eBPF/getting-start-with-eBPF/implementation-process.jpg">


<link rel="canonical" href="http://example.com/2022/12/06/eBPF/getting-start-with-eBPF/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/12/06/eBPF/getting-start-with-eBPF/","path":"2022/12/06/eBPF/getting-start-with-eBPF/","title":"eBPF 原理及其应用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>eBPF 原理及其应用 | champly</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="champly" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">champly</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">To be or not to be is up to you</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">10</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">5</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">7</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFeBPF"><span class="nav-number">1.</span> <span class="nav-text">什么是eBPF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">发展历程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">执行过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E5%88%B6"><span class="nav-number">2.2.</span> <span class="nav-text">限制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7"><span class="nav-number">3.1.</span> <span class="nav-text">开发工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91"><span class="nav-number">4.</span> <span class="nav-text">开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BCC"><span class="nav-number">4.1.</span> <span class="nav-text">BCC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E8%B0%83%E7%94%A8"><span class="nav-number">4.2.</span> <span class="nav-text">内核调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BPF-%E5%91%BD%E4%BB%A4"><span class="nav-number">4.2.1.</span> <span class="nav-text">BPF 命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BPF-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="nav-number">4.2.2.</span> <span class="nav-text">BPF 辅助函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BPF-%E6%98%A0%E5%B0%84"><span class="nav-number">4.2.3.</span> <span class="nav-text">BPF 映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BPF-%E7%B1%BB%E5%9E%8B%E6%A0%BC%E5%BC%8F-BTF"><span class="nav-number">4.2.4.</span> <span class="nav-text">BPF 类型格式(BTF)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%B1%BB"><span class="nav-number">4.3.</span> <span class="nav-text">分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%9F%E8%B8%AA%E7%B1%BB"><span class="nav-number">4.3.1.</span> <span class="nav-text">跟踪类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E7%B1%BB"><span class="nav-number">4.3.2.</span> <span class="nav-text">网络类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#XDP"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">XDP</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TC"><span class="nav-number">4.3.2.2.</span> <span class="nav-text">TC</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="nav-number">4.3.2.3.</span> <span class="nav-text">套接字</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cgroup"><span class="nav-number">4.3.2.4.</span> <span class="nav-text">cgroup</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.3.3.</span> <span class="nav-text">其他类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bpftrace"><span class="nav-number">4.4.</span> <span class="nav-text">bpftrace</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E7%A8%8B%E5%BA%8F%E8%B7%9F%E8%B8%AA%E7%82%B9"><span class="nav-number">4.4.1.</span> <span class="nav-text">查询用户程序跟踪点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%9F%E8%B8%AA-Go-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="nav-number">4.4.2.</span> <span class="nav-text">跟踪 Go 程序的执行</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#libbpf"><span class="nav-number">4.5.</span> <span class="nav-text">libbpf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BA%E5%88%AB"><span class="nav-number">4.6.</span> <span class="nav-text">区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%B7%9F%E8%B8%AA"><span class="nav-number">5.1.</span> <span class="nav-text">网络跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">5.2.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97%E4%BC%98%E5%8C%96"><span class="nav-number">5.2.1.</span> <span class="nav-text">套接字优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XDP%E4%BC%98%E5%8C%96"><span class="nav-number">5.2.2.</span> <span class="nav-text">XDP优化</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="champly"
      src="/images/themes/logo.jpeg">
  <p class="site-author-name" itemprop="name">champly</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/champly" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;champly" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:champly@outlook.com" title="E-Mail → mailto:champly@outlook.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
<div class="widget-wrap">
    <div id="myCanvasContainer" class="widget tagcloud">
        <canvas width="250" height="250" id="resCanvas" style="width:100%">
            <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CNI/" rel="tag">CNI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Distributed/" rel="tag">Distributed</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPVS/" rel="tag">IPVS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Next/" rel="tag">Next</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raft/" rel="tag">Raft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eBPF/" rel="tag">eBPF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a><span class="tag-list-count">1</span></li></ul>
        </canvas>
    </div>
</div>


        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/06/eBPF/getting-start-with-eBPF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/themes/logo.jpeg">
      <meta itemprop="name" content="champly">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="champly">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="eBPF 原理及其应用 | champly">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          eBPF 原理及其应用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-12-06 10:08:36" itemprop="dateCreated datePublished" datetime="2022-12-06T10:08:36+08:00">2022-12-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-11 13:53:11" itemprop="dateModified" datetime="2023-05-11T13:53:11+08:00">2023-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/eBPF/" itemprop="url" rel="index"><span itemprop="name">eBPF</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>29k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>27 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>该文档主要是<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100104501">《eBPF 核心技术与实战》</a>课程的笔记以及一些扩展。其中代码在<a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code">ebpf-learn-code</a>仓库中，编译环境都在 <code>Docker</code> 镜像中，也具备 <a target="_blank" rel="noopener" href="https://github.com/cilium/ebpf">cilium-ebpf</a> 的编译环境。</p>
</blockquote>
<h2 id="什么是eBPF"><a href="#什么是eBPF" class="headerlink" title="什么是eBPF"></a>什么是eBPF</h2><p><code>eBPF</code> 是从 <code>BPF</code> 技术扩展而来的，得益于 <code>BPF</code> 的设计:</p>
<ul>
<li>内核态引入一个新的虚拟机(执行引擎)，所有指令都在内核虚拟机中运行；</li>
<li>用户态使用 <code>BPF</code> 字节码来定义过滤表达式，然后传递给内核，由内核虚拟机解释执行。</li>
</ul>
<p>这就使得包过滤可以直接在内核中执行，避免了向用户态复制每个数据包，从而极大提升了包过滤的性能，进而被广大操作系统广泛接受。<em>而 <code>BPF</code> 最初的名字由最初的 <code>BSD Packet Filter</code> 变成了 <code>Berkeley Packet Filter</code></em> 。</p>
<h3 id="发展历程"><a href="#发展历程" class="headerlink" title="发展历程"></a>发展历程</h3><ul>
<li><code>BPF</code> 诞生五年后， <code>Linux</code> 2.1.75 首次引入了 <code>BPF</code> 技术;</li>
<li><code>Linux</code> 3.0 中增加的 <code>BPF</code> 即时编译器替换了原本性能较差的解释器，算是一个重大更新;</li>
<li>2014 年，为了研究新的SDN(软件定义网络)方案，第一次革命性的更新，将 <code>BPF</code> 扩展为一个通用的虚拟机，也就是 <code>eBPF</code>。不仅扩展了寄存器数量，引入了全新的 <code>BPF</code> 映射存储(Map)，还在 5.x 内核中将原本单一的数据包过滤事件逐步扩展到了内核态函数、用户态函数、跟踪点、性能事件(perf_events)以及安全控制等(转折点)。</li>
</ul>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p><code>eBPF</code> 程序并不像常规的线程那样，启动后就一直运行在那里，它需要事件触发后才会执行。这些事件包括系统调用、内核跟踪点、内核函数和用户态函数的调用退出、网络事件等等，借助强大的内核态插桩(kprobe)和用户态插桩(uprobe)，<code>eBPF</code> 程序几乎可以在内核和应用的任意位置进行插桩。</p>
<blockquote>
<p><strong>确保安全和稳定一直都是 <code>eBPF</code> 的首要任务，不安全的 <code>eBPF</code> 程序根本就不会提交到内核虚拟机中执行。</strong></p>
</blockquote>
<h3 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h3><p>如下图（图片来自<a target="_blank" rel="noopener" href="https://www.brendangregg.com/ebpf.html">www.brendangregg.com</a>）:</p>
<p><img data-src="/images/eBPF/getting-start-with-eBPF/implementation-process.jpg" alt="implementation-process" title="eBPF 执行过程"></p>
<p>通常借助 <code>LLVM</code> 把编写的 <code>eBPF</code> 程序转换为 <code>BPF</code> 字节码，然后再通过 <code>bpf</code> 系统调用提交给内核执行。内核在接受 <code>BPF</code> 字节码之前，会首先通过验证器对字节码进行校验，只有通过校验的 <code>BPF</code> 字节码才会提交到即时编译器(JIT)执行。如果 <code>BPF</code> 字节码中包含了不安全的操作，验证器会直接拒绝 <code>BPF</code> 程序的执行：</p>
<ul>
<li>只有特权进程才可以执行 <code>bpf</code> 系统调用;</li>
<li><code>BPF</code> 程序不能包涵无限循环;</li>
<li><code>BPF</code> 程序不能导致内核崩溃;</li>
<li><code>BPF</code> 程序必须在有限时间内完成。</li>
</ul>
<p><code>BPF</code> 程序可以利用 <code>BPF</code> 映射进行存储，而用户态程序通常也需要通过 <code>BPF</code> 映射同运行在内核中的 <code>BPF</code> 程序进行交互。如下图(<a target="_blank" rel="noopener" href="https://ebpf.io/what-is-ebpf/">ebpf.io</a>):</p>
<p><img data-src="/images/eBPF/getting-start-with-eBPF/verification-architecture.png" alt="verification-architecture.png"></p>
<h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><p><code>eBPF</code> 不是万能的，有很多限制：</p>
<ul>
<li><code>eBPF</code> 程序必须被验证器校验通过后才能执行，且不能包含无法到达的指令;</li>
<li><code>eBPF</code> 程序不能随意调用内核函数，只能调用在 <code>API</code> 中定义的辅助函数;</li>
<li><code>eBPF</code> 程序栈空间最多只有 512 字节，想要更大的存储，就必须要借助映射存储(Map);</li>
<li>在内核 5.2 之前，<code>eBPF</code> 字节码最多只支持 4096 条指令，而 5.2 内核把这个限制提高到了 100w 条;</li>
<li>由于内核的快速变化，在不同版本内核中运行时，需要访问内核数据结构的 <code>eBPF</code> 程序可能需要调整源码，并重写编译。</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>作为 <code>eBPF</code> 最重大的改进之一，一次编译到处执行(CO-RE)解决了内核数据结构在不同版本差异导致的兼容性问题，不过在使用 <code>CO-RE</code> 之前，需要内核开启 <code>CONFIG_DEBUG_INFO_BTF=y</code> 和 <code>CONFIG_DEBUG_INFO=y</code> 这两个编译选项。高版本已经默认开启，否则需要重新编译内核。</p>
<h3 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h3><p>主要包括:</p>
<ul>
<li>将 <code>eBPF</code> 程序编译成字节码的 <code>LLVM</code>;</li>
<li><code>C</code> 语言程序编译工具 <code>make</code>;</li>
<li>最流行的 <code>eBPF</code> 工具集 <code>BCC</code> 和它依赖的内核头文件;</li>
<li>与内核代码仓库实时同步的 <code>libbpf</code>;</li>
<li>同样是内核代码提供的 <code>eBPF</code> 程序管理工具 <code>bpftool</code>。</li>
</ul>
<p>可以通过下面的命令来统一安装:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For Ubuntu20.10+</span></span><br><span class="line">sudo apt-get install -y  make clang llvm libelf-dev libbpf-dev bpfcc-tools libbpfcc-dev linux-tools-$(uname -r) linux-headers-$(uname -r)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For RHEL8.2+</span></span><br><span class="line">sudo yum install libbpf-devel make clang llvm elfutils-libelf-devel bpftool bcc-tools bcc-devel</span><br></pre></td></tr></table></figure>

<p>也可以直接通过 <a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code">https://github.com/champly/ebpf-learn-code</a> 这个项目里面的环境来学习和测试，直接 <code>make run</code> 就可以了。</p>
<h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><p>一般来说，<code>eBPF</code>的开发和执行过程分为以下 5 步:</p>
<ul>
<li>使用 <code>C</code> 语言开发一个 <code>eBPF</code> 程序;</li>
<li>借助 <code>LLVM</code> 把 <code>eBPF</code> 程序编译成 <code>BPF</code> 字节码;</li>
<li>通过 <code>bpf</code> 系统调用，把 <code>BPF</code> 字节码提交给内核;</li>
<li>内核验证并运行 <code>BPF</code> 字节码，并把相应的程序状态保存到 <code>BPF</code> 映射中;</li>
<li>用户程序通过 <code>BPF</code> 映射查询 <code>BPF</code> 字节码的运行状态。</li>
</ul>
<h3 id="BCC"><a href="#BCC" class="headerlink" title="BCC"></a>BCC</h3><p><code>BCC</code> 是一个 <code>BPF</code> 编译器集合，包含了用于构建 <code>BPF</code> 程序的变成框架和库，并提供了大量可以直接使用的工具。把上述的 <code>eBPF</code> 执行过程通过内置框架抽象了起来，并提供了 <code>Python</code>、<code>C++</code> 等编程语言的接口，就可以简单通过 <code>Python</code> 语言去跟 <code>eBPF</code> 的各种事件和数据进行交互。</p>
<p>如下这个<a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/tree/main/code/session3">代码</a>:</p>
<figure class="highlight c"><figcaption><span>trace-open.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;uapi/linux/openat2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">  u32 pid;</span><br><span class="line">  u64 ts;</span><br><span class="line">  <span class="type">char</span> comm[TASK_COMM_LEN];</span><br><span class="line">  <span class="type">char</span> fname[NAME_MAX];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">BPF_PERF_OUTPUT(events);</span><br><span class="line"></span><br><span class="line"><span class="comment">// define kprobe function</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">hello_world2</span><span class="params">(<span class="keyword">struct</span> pt_regs *ctx, <span class="type">int</span> dfd, <span class="type">const</span> <span class="type">char</span> __user *filename,</span></span><br><span class="line"><span class="params">                 <span class="keyword">struct</span> open_how *how)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data</span> =</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get PID &amp; time</span></span><br><span class="line">  data.pid = bpf_get_current_pid_tgid();</span><br><span class="line">  data.ts = bpf_ktime_get_ns();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get program name</span></span><br><span class="line">  <span class="keyword">if</span> (bpf_get_current_comm(&amp;data.comm, <span class="keyword">sizeof</span>(data.comm)) == <span class="number">0</span>) &#123;</span><br><span class="line">    bpf_probe_read(&amp;data.fname, <span class="keyword">sizeof</span>(data.fname), (<span class="type">void</span> *)filename);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// submit event</span></span><br><span class="line">  events.perf_submit(ctx, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><figcaption><span>trace-open.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) load BPF program</span></span><br><span class="line">b = BPF(src_file=<span class="string">&quot;trace-open.c&quot;</span>)</span><br><span class="line">b.attach_kprobe(event=<span class="string">&quot;do_sys_openat2&quot;</span>, fn_name=<span class="string">&quot;hello_world2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) print header</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;%-18s %-16s %-6s %-16s&quot;</span> % (<span class="string">&quot;TIME(s)&quot;</span>, <span class="string">&quot;COMM&quot;</span>, <span class="string">&quot;PID&quot;</span>, <span class="string">&quot;FILE&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) define the callback for perf event</span></span><br><span class="line">start = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_event</span>(<span class="params">cpu, data, size</span>):</span><br><span class="line">    <span class="keyword">global</span> start</span><br><span class="line">    event = b[<span class="string">&quot;events&quot;</span>].event(data)</span><br><span class="line">    <span class="keyword">if</span> start == <span class="number">0</span>:</span><br><span class="line">        start = event.ts</span><br><span class="line">    time_s = (<span class="built_in">float</span>(event.ts - start)) / <span class="number">1000000000</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%-18.9s %-16s %-6d %16s&quot;</span> % (time_s, event.comm, event.pid, event.fname))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) loop with callback to print_event</span></span><br><span class="line">b[<span class="string">&quot;events&quot;</span>].open_perf_buffer(print_event)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        b.perf_buffer_poll()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>

<p>打开一个终端:</p>
<figure class="highlight shell"><figcaption><span>Terminal1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make run</span></span><br><span class="line">sh docker-run.sh</span><br><span class="line">root@9ceb0649d5e5:/# cd ~/code/session3/</span><br><span class="line">root@9ceb0649d5e5:~/code/session3# python3 trace-open.py</span><br><span class="line">TIME(s)            COMM             PID    FILE</span><br></pre></td></tr></table></figure>

<p>打开另外一个终端:</p>
<figure class="highlight shell"><figcaption><span>Terminal2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">champly @ champlydeiMac <span class="keyword">in</span> ~ [15:40:16]</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -it ebpf-for-mac bash</span></span><br><span class="line">root@9ceb0649d5e5:/# ls</span><br><span class="line">bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">root@9ceb0649d5e5:/#</span><br></pre></td></tr></table></figure>

<p>同时可以看到第一个终端有数据输出:</p>
<figure class="highlight shell"><figcaption><span>Terminal1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TIME(s)            COMM             PID    FILE</span><br><span class="line">0.0                b&#x27;ls&#x27;            8931   b&#x27;/etc/ld.so.cache&#x27;</span><br><span class="line">0.0006603          b&#x27;ls&#x27;            8931   b&#x27;/lib/x86_64-linux-gnu/libselinux.so.1&#x27;</span><br><span class="line">0.0007822          b&#x27;ls&#x27;            8931   b&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><span class="line">0.0008942          b&#x27;ls&#x27;            8931   b&#x27;/lib/x86_64-linux-gnu/libpcre2-8.so.0&#x27;</span><br><span class="line">0.0011795          b&#x27;ls&#x27;            8931   b&#x27;/proc/filesystems&#x27;</span><br><span class="line">0.0013228          b&#x27;ls&#x27;            8931               b&#x27;.&#x27;</span><br></pre></td></tr></table></figure>

<p>可以在第二个终端通过 <code>bpftool</code> 来查看 <code>eBPF</code> 程序的状态:</p>
<figure class="highlight shell"><figcaption><span>Terminal2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">root@9ceb0649d5e5:/# bpftool prog list</span><br><span class="line">3: cgroup_device  tag 531db05b114e9af3</span><br><span class="line">	loaded_at 2022-12-02T01:02:16+0000  uid 0</span><br><span class="line">	xlated 512B  jited 325B  memlock 4096B</span><br><span class="line">	</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">155: kprobe  name hello_world2  tag c3d700bdee3931e4  gpl</span><br><span class="line">	loaded_at 2022-12-06T07:41:43+0000  uid 0</span><br><span class="line">	xlated 528B  jited 359B  memlock 4096B  map_ids 296</span><br><span class="line">	btf_id 28</span><br><span class="line">root@9ceb0649d5e5:/# bpftool map list</span><br><span class="line">17: ringbuf  name blocked_packets  flags 0x0</span><br><span class="line">	key 0B  value 0B  max_entries 16777216  memlock 0B</span><br><span class="line">18: hash  name allowed_map  flags 0x0</span><br><span class="line">	key 4B  value 4B  max_entries 10000  memlock 81920B</span><br><span class="line">20: lpm_trie  name allowed_trie  flags 0x1</span><br><span class="line">	key 8B  value 8B  max_entries 1024  memlock 16384B</span><br><span class="line">297: perf_event_array  name events  flags 0x0</span><br><span class="line">	key 4B  value 4B  max_entries 1  memlock 4096B</span><br><span class="line">root@9ceb0649d5e5:/# bpftool map dump id 297</span><br><span class="line">key:</span><br><span class="line">00 00 00 00</span><br><span class="line">value:</span><br><span class="line">Unknown error 524</span><br><span class="line">Found 0 elements</span><br><span class="line">root@9ceb0649d5e5:/# bpftool prog dump xlated id 155</span><br><span class="line">int hello_world2(struct pt_regs * ctx):</span><br><span class="line">; int hello_world2(struct pt_regs *ctx) &#123;</span><br><span class="line">   0: (bf) r6 = r1</span><br><span class="line">; int dfd = ctx-&gt;di; const char __user *filename = ctx-&gt;si; struct open_how *how = ctx-&gt;dx;</span><br><span class="line">   1: (79) r7 = *(u64 *)(r6 +104)</span><br><span class="line">   2: (b7) r1 = 0</span><br><span class="line">; struct data_t data = &#123;&#125;;</span><br><span class="line">   3: (7b) *(u64 *)(r10 -8) = r1</span><br><span class="line">   4: (7b) *(u64 *)(r10 -16) = r1</span><br><span class="line">   5: (7b) *(u64 *)(r10 -24) = r1</span><br><span class="line">   6: (7b) *(u64 *)(r10 -32) = r1</span><br><span class="line">   7: (7b) *(u64 *)(r10 -40) = r1</span><br><span class="line">   8: (7b) *(u64 *)(r10 -48) = r1</span><br><span class="line">   9: (7b) *(u64 *)(r10 -56) = r1</span><br><span class="line">  10: (7b) *(u64 *)(r10 -64) = r1</span><br><span class="line">  11: (7b) *(u64 *)(r10 -72) = r1</span><br><span class="line">  12: (7b) *(u64 *)(r10 -80) = r1</span><br><span class="line">  13: (7b) *(u64 *)(r10 -88) = r1</span><br><span class="line">  14: (7b) *(u64 *)(r10 -96) = r1</span><br><span class="line">  15: (7b) *(u64 *)(r10 -104) = r1</span><br><span class="line">  16: (7b) *(u64 *)(r10 -112) = r1</span><br><span class="line">  17: (7b) *(u64 *)(r10 -120) = r1</span><br><span class="line">  18: (7b) *(u64 *)(r10 -128) = r1</span><br><span class="line">  19: (7b) *(u64 *)(r10 -136) = r1</span><br><span class="line">  20: (7b) *(u64 *)(r10 -144) = r1</span><br><span class="line">  21: (7b) *(u64 *)(r10 -152) = r1</span><br><span class="line">  22: (7b) *(u64 *)(r10 -160) = r1</span><br><span class="line">  23: (7b) *(u64 *)(r10 -168) = r1</span><br><span class="line">  24: (7b) *(u64 *)(r10 -176) = r1</span><br><span class="line">  25: (7b) *(u64 *)(r10 -184) = r1</span><br><span class="line">  26: (7b) *(u64 *)(r10 -192) = r1</span><br><span class="line">  27: (7b) *(u64 *)(r10 -200) = r1</span><br><span class="line">  28: (7b) *(u64 *)(r10 -208) = r1</span><br><span class="line">  29: (7b) *(u64 *)(r10 -216) = r1</span><br><span class="line">  30: (7b) *(u64 *)(r10 -224) = r1</span><br><span class="line">  31: (7b) *(u64 *)(r10 -232) = r1</span><br><span class="line">  32: (7b) *(u64 *)(r10 -240) = r1</span><br><span class="line">  33: (7b) *(u64 *)(r10 -248) = r1</span><br><span class="line">  34: (7b) *(u64 *)(r10 -256) = r1</span><br><span class="line">  35: (7b) *(u64 *)(r10 -264) = r1</span><br><span class="line">  36: (7b) *(u64 *)(r10 -272) = r1</span><br><span class="line">  37: (7b) *(u64 *)(r10 -280) = r1</span><br><span class="line">  38: (7b) *(u64 *)(r10 -288) = r1</span><br><span class="line">; data.pid = bpf_get_current_pid_tgid();</span><br><span class="line">  39: (85) call bpf_unspec#0</span><br><span class="line">; data.pid = bpf_get_current_pid_tgid();</span><br><span class="line">  40: (63) *(u32 *)(r10 -288) = r0</span><br><span class="line">; data.ts = bpf_ktime_get_ns();</span><br><span class="line">  41: (85) call bpf_unspec#0</span><br><span class="line">; data.ts = bpf_ktime_get_ns();</span><br><span class="line">  42: (7b) *(u64 *)(r10 -280) = r0</span><br><span class="line">; struct data_t data = &#123;&#125;;</span><br><span class="line">  43: (bf) r1 = r10</span><br><span class="line">  44: (07) r1 += -272</span><br><span class="line">; if (bpf_get_current_comm(&amp;data.comm, sizeof(data.comm)) == 0) &#123;</span><br><span class="line">  45: (b7) r2 = 16</span><br><span class="line">  46: (85) call bpf_unspec#0</span><br><span class="line">  47: (67) r0 &lt;&lt;= 32</span><br><span class="line">  48: (77) r0 &gt;&gt;= 32</span><br><span class="line">; if (bpf_get_current_comm(&amp;data.comm, sizeof(data.comm)) == 0) &#123;</span><br><span class="line">  49: (55) if r0 != 0x0 goto pc+5</span><br><span class="line">; bpf_probe_read(&amp;data.fname, sizeof(data.fname), (void *)filename);</span><br><span class="line">  50: (bf) r1 = r10</span><br><span class="line">  51: (07) r1 += -256</span><br><span class="line">; bpf_probe_read(&amp;data.fname, sizeof(data.fname), (void *)filename);</span><br><span class="line">  52: (b7) r2 = 255</span><br><span class="line">  53: (bf) r3 = r7</span><br><span class="line">  54: (85) call bpf_unspec#0</span><br><span class="line">; bpf_perf_event_output(ctx, bpf_pseudo_fd(1, -1), CUR_CPU_IDENTIFIER, &amp;data, sizeof(data));</span><br><span class="line">  55: (18) r2 = map[id:297]</span><br><span class="line">  57: (bf) r4 = r10</span><br><span class="line">  58: (07) r4 += -288</span><br><span class="line">; bpf_perf_event_output(ctx, bpf_pseudo_fd(1, -1), CUR_CPU_IDENTIFIER, &amp;data, sizeof(data));</span><br><span class="line">  59: (bf) r1 = r6</span><br><span class="line">  60: (18) r3 = 0xffffffff</span><br><span class="line">  62: (b7) r5 = 288</span><br><span class="line">  63: (85) call bpf_unspec#0</span><br><span class="line">; return 0;</span><br><span class="line">  64: (b7) r0 = 0</span><br><span class="line">  65: (95) exit</span><br></pre></td></tr></table></figure>

<p>可以查看到刚运行的 <code>eBPF</code> 程序的状态和 <code>map</code> 中的值，还有 <code>eBPF</code> 程序指令，通过 <code>bpftool prog dump jited id $ID</code> 可以查看到最后经过 <code>JIT</code> 编译之后的指令(当前 <code>Docker</code> 环境不支持，如果可以支持，请告诉我)。</p>
<p>还可以通过 <code>strace</code> 来查看 <code>eBPF</code> 程序的执行过程:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">root@9ceb0649d5e5:~/code/session3# strace -v -f -ebpf ./hello.py</span><br><span class="line">......</span><br><span class="line">bpf(</span><br><span class="line">    BPF_PROG_LOAD, </span><br><span class="line">    &#123;</span><br><span class="line">        prog_type=BPF_PROG_TYPE_KPROBE, </span><br><span class="line">        insn_cnt=13, </span><br><span class="line">        insns=[</span><br><span class="line">            &#123;code=BPF_ALU64|BPF_K|BPF_MOV, dst_reg=BPF_REG_1, src_reg=BPF_REG_0, off=0, imm=0x21646c72&#125;, </span><br><span class="line">            &#123;code=BPF_STX|BPF_W|BPF_MEM, dst_reg=BPF_REG_10, src_reg=BPF_REG_1, off=-8, imm=0&#125;, </span><br><span class="line">            &#123;code=BPF_LD|BPF_DW|BPF_IMM, dst_reg=BPF_REG_1, src_reg=BPF_REG_0, off=0, imm=0x6c6c6548&#125;, </span><br><span class="line">            &#123;code=BPF_LD|BPF_W|BPF_IMM, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0x6f57206f&#125;, </span><br><span class="line">            &#123;code=BPF_STX|BPF_DW|BPF_MEM, dst_reg=BPF_REG_10, src_reg=BPF_REG_1, off=-16, imm=0&#125;, </span><br><span class="line">            &#123;code=BPF_ALU64|BPF_K|BPF_MOV, dst_reg=BPF_REG_1, src_reg=BPF_REG_0, off=0, imm=0&#125;, </span><br><span class="line">            &#123;code=BPF_STX|BPF_B|BPF_MEM, dst_reg=BPF_REG_10, src_reg=BPF_REG_1, off=-4, imm=0&#125;, </span><br><span class="line">            &#123;code=BPF_ALU64|BPF_X|BPF_MOV, dst_reg=BPF_REG_1, src_reg=BPF_REG_10, off=0, imm=0&#125;, </span><br><span class="line">            &#123;code=BPF_ALU64|BPF_K|BPF_ADD, dst_reg=BPF_REG_1, src_reg=BPF_REG_0, off=0, imm=0xfffffff0&#125;, </span><br><span class="line">            &#123;code=BPF_ALU64|BPF_K|BPF_MOV, dst_reg=BPF_REG_2, src_reg=BPF_REG_0, off=0, imm=0xd&#125;, </span><br><span class="line">            &#123;code=BPF_JMP|BPF_K|BPF_CALL, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0x6&#125;, </span><br><span class="line">            &#123;code=BPF_ALU64|BPF_K|BPF_MOV, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0&#125;, </span><br><span class="line">            &#123;code=BPF_JMP|BPF_K|BPF_EXIT, dst_reg=BPF_REG_0, src_reg=BPF_REG_0, off=0, imm=0&#125;</span><br><span class="line">        ], </span><br><span class="line">        license=&quot;GPL&quot;, </span><br><span class="line">        log_level=0, </span><br><span class="line">        log_size=0, </span><br><span class="line">        log_buf=NULL, </span><br><span class="line">        kern_version=KERNEL_VERSION(5, 15, 49), </span><br><span class="line">        prog_flags=0, </span><br><span class="line">        prog_name=&quot;hello_world&quot;, </span><br><span class="line">        prog_ifindex=0, </span><br><span class="line">        expected_attach_type=BPF_CGROUP_INET_INGRESS, </span><br><span class="line">        prog_btf_fd=3, </span><br><span class="line">        func_info_rec_size=8, </span><br><span class="line">        func_info=0x55d9d310c030, </span><br><span class="line">        func_info_cnt=1, </span><br><span class="line">        line_info_rec_size=16, </span><br><span class="line">        line_info=0x55d9d30ebf10, </span><br><span class="line">        line_info_cnt=5, </span><br><span class="line">        attach_btf_id=0, </span><br><span class="line">        attach_prog_fd=0, </span><br><span class="line">        fd_array=NULL</span><br><span class="line">    &#125;, 144) = 4</span><br></pre></td></tr></table></figure>

<p><em>如果去掉 <code>-ebpf</code> 可以看到更多的过程。</em></p>
<h3 id="内核调用"><a href="#内核调用" class="headerlink" title="内核调用"></a>内核调用</h3><p>对于用户态程序来说，它们与内核交互时必须要通过系统调用来完成。而对于 <code>eBPF</code> 程序需要通过 <code>bpf</code> 系统调用 <code>man bpf</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       bpf - perform a command on an extended BPF map or program</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">       #include &lt;linux/bpf.h&gt;</span><br><span class="line"></span><br><span class="line">       int bpf(int cmd, union bpf_attr *attr, unsigned int size);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.1-rc8/source/include/uapi/linux/bpf.h#L865">include&#x2F;uapi&#x2F;linux&#x2F;bpf.h</a> 可以查看支持的 <code>BPF</code> 命令。</p>
<h4 id="BPF-命令"><a href="#BPF-命令" class="headerlink" title="BPF 命令"></a>BPF 命令</h4><table>
<thead>
<tr>
<th align="center">BPF命令</th>
<th align="center">功能描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BPF_MAP_CREATE</td>
<td align="center">创建一个 BPF 映射</td>
</tr>
<tr>
<td align="center">BPF_MAP_LOOKUP_ELEM<br>BPF_MAP_UPDATE_ELEM<br>BPF_MAP_DELETE_ELEM<br>BPF_MAP_LOOKUP_AND_DELETE_ELEM<br>BPF_MAP_GET_NEXT_KEY</td>
<td align="center">BPF 映射相关的操作命令，包括查找、更新、删除以及遍历等</td>
</tr>
<tr>
<td align="center">BPF_PROG_LOAD</td>
<td align="center">验证并加载 BPF 程序</td>
</tr>
<tr>
<td align="center">BPF_PROG_ATTACH</td>
<td align="center">把 BPF 程序挂载到内核事件上</td>
</tr>
<tr>
<td align="center">BPF_PROG_DETACH</td>
<td align="center">把 BPF 程序从内核事件上卸载</td>
</tr>
<tr>
<td align="center">BPF_OBJ_PIN</td>
<td align="center">把 BPF 程序或映射挂载到sysfs中的&#x2F;sys&#x2F;fs&#x2F;bpf目录中 （常用于保持 BPF 程序在内核中贮存）</td>
</tr>
<tr>
<td align="center">BPF_OBJ_GET</td>
<td align="center">从&#x2F;sys&#x2F;fs&#x2F;bpf目录中查找 BPF 程序 BPF_BTF_LOAD 验证并加载 BTF 信息</td>
</tr>
</tbody></table>
<h4 id="BPF-辅助函数"><a href="#BPF-辅助函数" class="headerlink" title="BPF 辅助函数"></a>BPF 辅助函数</h4><p>可以通过 <code>bpftool feature probe</code> 来查询当前系统支持的辅助函数列表，详细定义可以使用 <code>man bpf-helpers</code>，或者参考内核头文件 <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.1-rc8/source/include/uapi/linux/bpf.h#L1567">&#x2F;include&#x2F;uapi&#x2F;linux&#x2F;bpf.h</a>:</p>
<table>
<thead>
<tr>
<th align="center">辅助函数</th>
<th align="center">功能描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">bpf_trace_printk(fmt, fmt_size, …)</td>
<td align="center">向调试文件系统写入调试信息</td>
</tr>
<tr>
<td align="center">bpf_map_lookup_elem(map, key)<br>bpf_map_update_elem(map, key, value, flags)<br>bpf_map_delete_elem(map, key)</td>
<td align="center">BPF映射操作函数，分别是查找、更新和删除元素</td>
</tr>
<tr>
<td align="center">bpf_probe_read(dst, size, ptr)<br>bpf_probe_read_user(dst, size, ptr)<br>bpf_probe_read_kernel(dst, size, ptr)</td>
<td align="center">从内存指针中读取数据<br>从用户空间内存指针中读取数据<br>从内核空间内存指针中读取数据</td>
</tr>
<tr>
<td align="center">bpf_ktime_get_ns()</td>
<td align="center">获取系统启动以来的时长，单位纳秒</td>
</tr>
<tr>
<td align="center">bpf_get_current_pid_tgid()</td>
<td align="center">获取当前线程的TGID（高32位）和PID（低32位）</td>
</tr>
<tr>
<td align="center">bpf_get_current_comm(buf, size)</td>
<td align="center">获取当前线程的任务名称</td>
</tr>
<tr>
<td align="center">bpf_get_current_task()</td>
<td align="center">获取当前任务的task结构体</td>
</tr>
<tr>
<td align="center">bpf_perf_event_output(ctx, map, flags, data, size)</td>
<td align="center">向性能事件缓冲区中写入数据</td>
</tr>
<tr>
<td align="center">bpf_get_stackid(ctx, map, flags)</td>
<td align="center">获取内核态和用户态调用栈</td>
</tr>
</tbody></table>
<h4 id="BPF-映射"><a href="#BPF-映射" class="headerlink" title="BPF 映射"></a>BPF 映射</h4><p><code>BPF</code> 映射用于提供大块的键值存储，这些存储可被用户控件程序访问，进而获取 <code>ePBF</code> 程序的运行状态。<code>eBPF</code> 程序最多可以访问 64 个不同的 <code>BPF</code> 映射，并且不同的 <code>eBPF</code> 程序也可以通过相同的 <code>BPF</code> 映射来共享它们的状态。</p>
<p><img data-src="/images/eBPF/getting-start-with-eBPF/bpf-map.jpg" alt="bpf-map.jpg"></p>
<p><code>BPF</code> 映射只能通过用户态程序的系统调用来创建，内核头文件 <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.1-rc8/source/include/uapi/linux/bpf.h#L905">&#x2F;include&#x2F;uapi&#x2F;linux&#x2F;bpf.h</a> 中的 <code>bpf_map_type</code> 定义了所有支持的映射类型，也可以通过 <code>bpftool feature probe | grep map_type</code> 来查询当前系统支持哪些映射。</p>
<table>
<thead>
<tr>
<th align="center">映射类型</th>
<th align="center">功能描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BPF_MAP_TYPE_HASH</td>
<td align="center">哈希表映射，用于保存 key&#x2F;value对</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_LRU_HASH</td>
<td align="center">类似于哈希表映射，但在表满的时候自动按LRU 算法删除最久未被使用的元素</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_ARRAY</td>
<td align="center">数组映射，用于保存固定大小的数组（注意数组元素无法删除）</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_PROG_ARRAY</td>
<td align="center">程序数组映射，用于保存 BPF 程序的引用，特别适合于尾调用（即调用其他 eBPF 程序)</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_PERF_EVENT_ARRAY</td>
<td align="center">性能事件数组映射，用于保存性能事件跟踪记录</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPEPERCPU_HASH<br>BPF_MAP_TYPE_PERCPU_ARRAY</td>
<td align="center">每个 CPU 单独维护的哈希表和数组映射</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_STACK_TRACE</td>
<td align="center">调用栈跟踪映射，用于存储调用栈信息</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_ARRAY_OF_MAPS<br>BPF_MAP_TYPE_HASH_OF_MAPS</td>
<td align="center">映射数组和映射哈希，用于保存其他映射的引用</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_CGROUP_ARRAY</td>
<td align="center">CGROUP 数组映射，用于存储 cgroups 引用</td>
</tr>
<tr>
<td align="center">BPF_MAP_TYPE_SOCKMAP</td>
<td align="center">套接字映射，用于存储套接字引用，特别适用于套接字重定向</td>
</tr>
</tbody></table>
<blockquote>
<p>** BPF 映射会在用户态程序关闭文件描述符的时候自动删除**，如果想在程序退出后还保留映射，需要调用 <code>BPF_OBJ_PIN</code> 命令，将映射挂载到 <code>/sys/fs/bpf</code> 中。</p>
</blockquote>
<p>通过 <code>bpftool</code> 来查看或操作映射的具体内容:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@76f664f7d01b:~/code/session3# bpftool map create /sys/fs/bpf/stats_map type hash key 2 value 2 entries 8 name stats_map</span><br><span class="line">root@76f664f7d01b:~/code/session3# bpftool map</span><br><span class="line">17: ringbuf  name blocked_packets  flags 0x0</span><br><span class="line">	key 0B  value 0B  max_entries 16777216  memlock 0B</span><br><span class="line">18: hash  name allowed_map  flags 0x0</span><br><span class="line">	key 4B  value 4B  max_entries 10000  memlock 81920B</span><br><span class="line">20: lpm_trie  name allowed_trie  flags 0x1</span><br><span class="line">	key 8B  value 8B  max_entries 1024  memlock 16384B</span><br><span class="line">304: hash  name stats_map  flags 0x0</span><br><span class="line">	key 2B  value 2B  max_entries 8  memlock 4096B</span><br><span class="line">root@76f664f7d01b:~/code/session3# bpftool map update name stats_map key 0xc1 0xc2 value 0xa1 0xa2</span><br><span class="line">root@76f664f7d01b:~/code/session3# bpftool map dump name stats_map</span><br><span class="line">key: c1 c2  value: a1 a2</span><br><span class="line">Found 1 element</span><br><span class="line">root@76f664f7d01b:~/code/session3# rm /sys/fs/bpf/stats_map</span><br><span class="line">root@76f664f7d01b:~/code/session3#</span><br></pre></td></tr></table></figure>

<h4 id="BPF-类型格式-BTF"><a href="#BPF-类型格式-BTF" class="headerlink" title="BPF 类型格式(BTF)"></a>BPF 类型格式(BTF)</h4><p>开发 <code>eBPF</code> 程序时最常碰到的问题：内核数据结构的定义。安装 <code>BCC</code> 工具的时候会安装 <code>linux-headers-$&#123;uname -r&#125;</code> 依赖项。因为 <code>BCC</code> 在编译的时候需要从内核头文件中找到相应的内核数据结构定义。但是编译时依赖内核头文件也会带来很多问题:</p>
<ul>
<li><code>eBPF</code> 程序开发的时候为了获得内核数据结构的定义，就需要引入一大堆的内核头文件;</li>
<li>内核头文件的路径和数据结构定义在不同内核版本中很可能不同。因此，在升级内核版本时，就会遇到找不到头文件和数据结构定义错误的问题;</li>
<li>在很多生产环境的机器中，出于安全考虑，并不允许安装内核头文件，这时就无法得到内核数据结构的定义。在程序中定义数据结构虽然可以暂时解决问题，但也很容易把使用着错误数据结构的 <code>eBPF</code> 程序带入新版本内核中运行。</li>
</ul>
<p><code>BPF</code> 类型格式(BPF Type Format,BTF) 的诞生就是为了解决这些问题。从内核 5.2 开始，只要开启了 <code>CONFIG_DEBUG_INFO_BTF</code>，在编译内核时，内核数据结构的定义就会自动内嵌在内核二进制文件 <code>vmlinux</code> 中。可以借助下面的命令把这些数据结构的定义导出到一个头文件中 <code>vmlinux.h</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h</span><br></pre></td></tr></table></figure>

<p>解决了内核数据结构的定义问题，接下来就是<strong>如何让eBPF程序在升级内核之后，不需要重新编译就可以直接运行</strong>(CO-RE)，<code>eBPF</code> 的一次编译到处执行项目借助了 <code>BTF</code> 提供的调试信息，再通过下面两个步骤，使得 <code>eBPF</code> 程序可以适配不同版本的内核:</p>
<ul>
<li>通过对 <code>BPF</code> 代码中的访问偏移量进行重写，解决了不同内核版本中数据结构偏移量不同的问题;</li>
<li>在 <code>libbpf</code> 中预定不同内核版本中的数据结构的修改，解决了不同内核数据结构不兼容的问题。</li>
</ul>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><h4 id="跟踪类"><a href="#跟踪类" class="headerlink" title="跟踪类"></a>跟踪类</h4><p>主要用于从系统中提取跟踪信息，进而为监控、排错、性能优化等提供数据支撑:</p>
<table>
<thead>
<tr>
<th align="center">程序类型</th>
<th align="center">功能描述</th>
<th align="center">功能限制</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BPF_PROG_TYPE_KPROBE</td>
<td align="center">用于对特定函数进行动态插桩，根据函数位置的不同，又可以分为内核态 kprobe 和用户态 uprobe</td>
<td align="center">内核函数和用户函数的定义属于不稳定 API，在不同内核版本中使用时，可能需要调整 eBPF 代码实现</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPETRACEPOINT</td>
<td align="center">用于内核静态跟踪点（可以 使用 perf list 命令，查询所 有的跟踪点）</td>
<td align="center">虽然跟踪点可以保持稳定性，但不如 KPROBE 类型 灵活，无法按需增加新的跟踪点</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_PERF_EVENT</td>
<td align="center">用于性能事件 (perf_events）跟踪，包括 内核调用、定时器、硬件等 各类性能数据</td>
<td align="center">需配合 BPF_MAP_TYPE_PERF_EVENT_ARRAY 或 BPF_MAP_TYPE_RINGBUF 类型的映射使用</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_RAW_TRACEPOINT<br>BPF_PROG_TYPE_RAW_TRACEPOINT_WRITABLE</td>
<td align="center">用于原始跟踪点</td>
<td align="center">不处理参数</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_TRACING</td>
<td align="center">用于开启 BTF 的跟踪点 需要开启 BTF</td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="网络类"><a href="#网络类" class="headerlink" title="网络类"></a>网络类</h4><p>主要用于对网络数据包进行过滤和处理，进而实现网络对观测、过滤、流量控制以及性能优化等各种丰富的功能。根据事件触发的位置不同，又可以分为 <code>XDP</code>(eXpress Data Path, 高速数据路径)程序、<code>TC</code>(Traffic Control, 流量控制)程序、套接字程序以及 <code>cgroup</code> 程序:</p>
<h5 id="XDP"><a href="#XDP" class="headerlink" title="XDP"></a>XDP</h5><p>在网络驱动程序刚刚收到数据包时触发执行。由于无需通过繁杂的内核网络协议栈，<code>XDP</code> 程序可以用来实现高性能的网络处理方案，常用于 <code>DDos</code> 防御、防火墙、4 层负载均衡等场景。根据网卡和网卡驱动是否是原生支持 <code>XDP</code> 程序，<code>XDP</code> 运行模式可以分为:</p>
<ul>
<li>通用模式：不需要网卡和网卡驱动支持，XDP 程序像常规的网络协议栈一样运行在内核中，性能相对较差，一般用于测试;</li>
<li>原生模式：需要网卡驱动支持，XDP 程序在网卡驱动程序的早期路径运行;</li>
<li>卸载模式：需要网卡固件支持 XDP 卸载，XDP 程序直接运行在网卡上，而不再需要消耗主机的 CPU 资源，具有最好的性能。</li>
</ul>
<p>不管什么模式，<code>XDP</code> 程序在处理过网络包之后，都需要根据 <code>eBPF</code> 程序执行的结果决定数据包的去处：</p>
<table>
<thead>
<tr>
<th align="center">结果码</th>
<th align="center">含义</th>
<th align="center">使用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center">XDP_DROP</td>
<td align="center">丢包</td>
<td align="center">数据包尽早丢弃可以减少 CPU 处理时间，因而常用于防火墙、DDos 防御等丢弃非法包的场景</td>
</tr>
<tr>
<td align="center">XDP_PASS</td>
<td align="center">传递到内核协议栈</td>
<td align="center">内核协议栈接收到网络包，按正常流程继续处理</td>
</tr>
<tr>
<td align="center">XDP_TX<br>XDP_REDIRECT</td>
<td align="center">转发数据包到同一网卡&#x2F;不同网卡</td>
<td align="center">数据包在 XDP 程序修改后转发到网卡中，继续按正常的内核协议栈流程处理，常用在负载均衡中</td>
</tr>
<tr>
<td align="center">XDP_ABORTED</td>
<td align="center">错误</td>
<td align="center">XDP 程序运行错误，数据包丢弃并记录错误行为，以便排错</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>只能用于接收!</strong></p>
</blockquote>
<h5 id="TC"><a href="#TC" class="headerlink" title="TC"></a>TC</h5><p>定义为 <code>BPF_PROG_TYPE_SCHED_CLS</code> 和 <code>BPF_PROG_TYPE_SCHED_ACT</code>，分别作为 Linux 流量控制的分类器和执行器。得益于内核 4.4 引入的 <code>direct-action</code> 模式，<code>TC</code> 程序可以直接在一个程序内完成分类和执行的动作，无需再调用其他的 <code>TC</code> 排队规则和分类器。</p>
<p>同 <code>XDP</code> 程序相比，<code>TC</code> 程序可以直接获取内核解析后的网络报文数据结构 <code>sk_buff</code> (<code>XDP</code> 是 <code>xdp_buff</code>)，并且可以在<strong>网卡的接收和发送两个方向上执行</strong>:</p>
<ul>
<li>对于接收网络包，TC 程序在网卡接收(GRO)之后、协议栈处理(包括 IP 层处理和 iptables 等)之前执行;</li>
<li>对于发送的网络包，TC 程序在协议处理（包括 IP 层处理和 iptables 等）之后、数据包发送到网卡队列(GSO)之前执行。</li>
</ul>
<p><img data-src="/images/eBPF/getting-start-with-eBPF/tc-process.jpg" alt="tc-process.jpg"></p>
<h5 id="套接字"><a href="#套接字" class="headerlink" title="套接字"></a>套接字</h5><p>用于过滤、观测或重定向套接字网络包，根据类型的不同，可以挂载到套接字(socket)、控制组(cgroup)以及网络命名空间(netns)等各个位置:</p>
<table>
<thead>
<tr>
<th align="center">套接字程序类型</th>
<th align="center">应用场景</th>
<th align="center">挂载方法</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BPF_PROG_TYPE_SOCKET_FILTER</td>
<td align="center">用于套接字过滤和观测</td>
<td align="center">用户态程序可通过系统调用 setsockopt(sock, SOL_SOCKET, SO_ATTACH_BPF,…），绑定 BPF 程序到具体的 socket 上</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_SOCKOPS</td>
<td align="center">用于套接字修改或重定向</td>
<td align="center">用户态程序可通过 BPF 系统调用的 BPF_PROG_ATTACH 命令（指定挂载类型为 BPF_CGROUP_SOCK_OPS)，将其挂载到 cgroup 上</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_SKSKB</td>
<td align="center">用于套接字修改或消息流动态解析</td>
<td align="center">用户态程序可通过 BPF 系统调用的 BPF_PROG_ATTACH 命令（指定挂载类型为 BPF_SK_SKB_STREAM_VERDICT 或 BPF_SK_SKB_STREAM_PARSER)，将其挂载到 BPF_MAP_TYPE_SOCKMAP 类型的 BPF 映射上</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPESKMSG</td>
<td align="center">用于控制内核是否发送消息到套接字</td>
<td align="center">用户态程序可通过 BPF 系统调用的 BPF_PROG_ATTACH 命令（指定挂载类型为 BPF_SK_MSG_VERDICT) 将其挂载到 BPF_MAP_TYPE_SOCKMAP 类型的 BPF 映射上</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_SK_REUSEPORT</td>
<td align="center">用于控制端口是否重用</td>
<td align="center">用户态程序可通过系统调用 setsockopt(sock, SOL_SOCKET, SO_ATTACH_REUSEPORT_EBPF, …），绑定 BPF 程序到具体的 socket 上</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_SK_LOOKUP</td>
<td align="center">用于为新的 TCP 连接选择监听套接字，或为 UDP 数据包选择未连接的套接字，可用来绕过 bind 系统调用的限制</td>
<td align="center">用户态程序可通过系统调用 bpf(BPF_LINK_CREATE,.，绑定 BPF 程序到网 络命名空间 (netns)上</td>
</tr>
</tbody></table>
<h5 id="cgroup"><a href="#cgroup" class="headerlink" title="cgroup"></a>cgroup</h5><p>用于对 cgroup 内所有进程的网络过滤、套接字选项以及转发等进行动态控制，最典型的应用场景是对容器中运行的多个进程进行网络控制:</p>
<table>
<thead>
<tr>
<th align="center">cgroup 程序类型</th>
<th align="center">应用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BPF_PROG_TYPECGROUP_SKB</td>
<td align="center">在入口和出口过滤数据包，并可以接受或拒绝数据包</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_CGROUP_SOCK</td>
<td align="center">在套接字创建、释放和绑定地址时，接受或拒绝操作，也可用来统计套接字信息</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_CGROUP_SOCKOPT</td>
<td align="center">在 setsockopt 和 getsockopt 操作中修改套接字选项</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_CGROUP_SOCKADDR</td>
<td align="center">在 connect、 bind、 sendto 和 recvmsg 操作中，修改 IP 地址和端口</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_CGROUP_DEVICE</td>
<td align="center">对设备文件的访问进行过滤</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_CGROUP_SYSCTL</td>
<td align="center">对 sysctl 的访问进行过滤</td>
</tr>
</tbody></table>
<h4 id="其他类型"><a href="#其他类型" class="headerlink" title="其他类型"></a>其他类型</h4><table>
<thead>
<tr>
<th align="center">BPF程序类型</th>
<th align="center">应用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center">BPF PROG_TYPE_LSM</td>
<td align="center">用于 Linux 安全模块(Linux Security Module,LSM）访问控制和审计策略</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_LWT_IN<br>BPF_PROG_TYPE_LWT_OUT<br>BPF_PROG_TYPE_LWT_XMIT</td>
<td align="center">用于轻量级隧道（如 vxlan、 mpls 等）的封装或解封装</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_LIRC_MODE2</td>
<td align="center">用于红外设备的远程遥控</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_STRUCT_OPS</td>
<td align="center">用于修改内核结构体，目前仅支持拥塞控制算法 tcp_congestion_ops</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_FLOW_DISSECTOR</td>
<td align="center">用于内核流量解析器 (Flow Dissector)</td>
</tr>
<tr>
<td align="center">BPF_PROG_TYPE_EXT</td>
<td align="center">用于扩展BPF程序</td>
</tr>
</tbody></table>
<h3 id="bpftrace"><a href="#bpftrace" class="headerlink" title="bpftrace"></a>bpftrace</h3><p><code>bpftrace</code> 在 <code>eBPF</code> 和 <code>BCC</code> 之上构建了一个简化的跟踪语言，通过简单的几行脚本，就可以实现复杂的追踪功能。<a target="_blank" rel="noopener" href="https://github.com/iovisor/bpftrace/blob/master/docs/internals_development.md">如下图</a> 所示, <code>bpftrace</code> 会把开发的脚本借助 <code>BCC</code> 编译加载到内核中执行，再通过 <code>BPF</code> 映射获取执行结果:</p>
<p><img data-src="/images/eBPF/getting-start-with-eBPF/bpftrace-internals.png" alt="bpftrace-internals.png"></p>
<p>通过 <code>bpftrace -l</code> 可以查询内核插桩和跟踪点 <code>-v</code> 可以查看函数的入口参数和返回值。</p>
<blockquote>
<p><strong>在内核插桩和跟踪点两者都可以用的情况下，应该选择更稳定的跟踪点，以保证 eBPF 程序的可移植性(即在不同的内核中都可以正常执行)。</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@f287ed60a8b5:/# bpftrace -lv &#x27;tracepoint:syscalls:sys_enter_execve&#x27;</span><br><span class="line">tracepoint:syscalls:sys_enter_execve</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    const char __attribute__((user)) * filename</span><br><span class="line">    const char __attribute__((user)) *const __attribute__((user)) * argv</span><br><span class="line">    const char __attribute__((user)) *const __attribute__((user)) * envp</span><br><span class="line">root@f287ed60a8b5:/# bpftrace -lv &#x27;tracepoint:syscalls:sys_exit_execve&#x27;</span><br><span class="line">tracepoint:syscalls:sys_exit_execve</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    long ret</span><br><span class="line">root@f287ed60a8b5:/# bpftrace -lv &#x27;tracepoint:syscalls:sys_enter_execveat&#x27;</span><br><span class="line">tracepoint:syscalls:sys_enter_execveat</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    int fd</span><br><span class="line">    const char __attribute__((user)) * filename</span><br><span class="line">    const char __attribute__((user)) *const __attribute__((user)) * argv</span><br><span class="line">    const char __attribute__((user)) *const __attribute__((user)) * envp</span><br><span class="line">    int flags</span><br><span class="line">root@f287ed60a8b5:/# bpftrace -lv &#x27;tracepoint:syscalls:sys_exit_execveat&#x27;</span><br><span class="line">tracepoint:syscalls:sys_exit_execveat</span><br><span class="line">    int __syscall_nr</span><br><span class="line">    long ret</span><br></pre></td></tr></table></figure>

<p>通过这个<a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/blob/main/code/session7/bpftrace/sys_enter.bt">代码</a>可以达到上面的 <code>BCC</code> 事例的效果:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@f287ed60a8b5:~/code/session7/bpftrace# bpftrace sys_enter.bt</span><br><span class="line">Attaching 2 probes...</span><br><span class="line">14:37:54  1785   0      bash            bpftool prog list</span><br></pre></td></tr></table></figure>

<h4 id="查询用户程序跟踪点"><a href="#查询用户程序跟踪点" class="headerlink" title="查询用户程序跟踪点"></a>查询用户程序跟踪点</h4><p>可以通过 <code>readelf</code> 查询二进制文件的基本信息，使用<a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/blob/main/code/session9/main.go">这个</a> <code>Go</code> 语言项目来示范:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rand.Seed(<span class="type">int64</span>(time.Now().Nanosecond()))</span><br><span class="line">	i := rand.Intn(<span class="number">10</span>)</span><br><span class="line">	a := callbackTP(i)</span><br><span class="line">	fmt.Println(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callbackTP</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> i &lt; <span class="number">5</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> i</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> a := <span class="number">0</span>; a &lt; i; a++ &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;xxxxx %d&quot;</span>, a)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">99</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在上面的容器环境中调试，<code>cd /root/code/session9 &amp;&amp; go build main.go</code> 进行编译，然后通过 <code>readelf</code> 查看对应的信息:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询符号表</span></span><br><span class="line">root@76f664f7d01b:~/code/session9# readelf -Ws ./main</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 2136 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS go.go</span><br><span class="line">     2: 0000000000401000     0 FUNC    LOCAL  DEFAULT    1 runtime.text</span><br><span class="line">     3: 0000000000402140   557 FUNC    LOCAL  DEFAULT    1 cmpbody</span><br><span class="line">     4: 00000000004023a0   318 FUNC    LOCAL  DEFAULT    1 memeqbody</span><br><span class="line">     5: 0000000000402520   279 FUNC    LOCAL  DEFAULT    1 indexbytebody</span><br><span class="line">     6: 0000000000459f60    64 FUNC    LOCAL  DEFAULT    1 gogo</span><br><span class="line">     7: 0000000000459fa0    53 FUNC    LOCAL  DEFAULT    1 callRet</span><br><span class="line">     8: 0000000000459fe0    47 FUNC    LOCAL  DEFAULT    1 gosave_systemstack_switch</span><br><span class="line">     9: 000000000045a020    13 FUNC    LOCAL  DEFAULT    1 setg_gcc</span><br><span class="line">    10: 000000000045a040  1370 FUNC    LOCAL  DEFAULT    1 aeshashbody</span><br><span class="line">    11: 000000000045a5a0    75 FUNC    LOCAL  DEFAULT    1 debugCall32</span><br><span class="line">......</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询USDT信息（USDT信息位于ELF文件的notes段）</span></span><br><span class="line">root@76f664f7d01b:~/code/session9# readelf -n ./main</span><br><span class="line"></span><br><span class="line">Displaying notes found in: .note.go.buildid</span><br><span class="line">  Owner                Data size 	Description</span><br><span class="line">  Go                   0x00000053	GO BUILDID</span><br><span class="line">   description data: 4e 6d 53 72 46 41 6d 53 44 30 6a 69 5a 6e 73 51 55 5a 74 55 2f 45 56 77 62 5a 5a 33 31 33 35 59 4f 76 5f 51 75 30 70 5a 61 2f 43 46 50 62 66 2d 67 78 4a 39 74 31 61 69 78 53 51 4b 57 32 2f 33 76 67 6b 73 51 37 38 5a 4f 73 7a 4c 5a 33 6e 41 4d 4d 52</span><br></pre></td></tr></table></figure>

<p>也可以通过 <code>bpftrace</code> 来查看:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询 uprobe</span></span><br><span class="line">root@76f664f7d01b:~/code/session9# bpftrace -l &quot;uprobe:./main:*&quot;</span><br><span class="line">uprobe:./main:_rt0_amd64</span><br><span class="line">uprobe:./main:_rt0_amd64_linux</span><br><span class="line">uprobe:./main:aeshashbody</span><br><span class="line">uprobe:./main:callRet</span><br><span class="line">uprobe:./main:cmpbody</span><br><span class="line">uprobe:./main:debugCall1024</span><br><span class="line">uprobe:./main:debugCall128</span><br><span class="line">uprobe:./main:debugCall16384</span><br><span class="line">uprobe:./main:debugCall2048</span><br><span class="line">uprobe:./main:debugCall256</span><br><span class="line">uprobe:./main:debugCall32</span><br><span class="line">uprobe:./main:debugCall32768</span><br><span class="line">uprobe:./main:debugCall4096</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询 usdt，这里的 Go 项目没有，通过 /usr/lib/x86_64-linux-gnu/libc.so.6 来替换</span></span><br><span class="line">root@76f664f7d01b:~/code/session9# bpftrace -l &#x27;usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:*&#x27;</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:cond_broadcast</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:cond_destroy</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:cond_init</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:cond_signal</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:cond_wait</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:lll_lock_wait</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:lll_lock_wait_private</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:longjmp</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:longjmp_target</span><br><span class="line">usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:libc:memory_arena_new</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>想要通过二进制文件查询符号表和参数定义，必须在编译的时候保留 DWARF 调试信息。</strong></p>
</blockquote>
<h4 id="跟踪-Go-程序的执行"><a href="#跟踪-Go-程序的执行" class="headerlink" title="跟踪 Go 程序的执行"></a>跟踪 Go 程序的执行</h4><figure class="highlight shell"><figcaption><span>Terminal1:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@76f664f7d01b:~/code/session9# bpftrace -e &#x27;</span><br><span class="line">        uprobe:./main:main.callbackTP &#123; printf(&quot;main.callbackTP i: %d =&gt; &quot;, reg(&quot;ax&quot;)) &#125;</span><br><span class="line">        uretprobe:./main:main.callbackTP &#123; printf(&quot;return %d\n&quot;, retval) &#125;</span><br><span class="line">&#x27;</span><br><span class="line">Attaching 2 probes...</span><br><span class="line">main.callbackTP i: 0 =&gt; return 0</span><br><span class="line">main.callbackTP i: 2 =&gt; return 2</span><br><span class="line">main.callbackTP i: 8 =&gt; return 99</span><br><span class="line">main.callbackTP i: 6 =&gt; return 99</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><figcaption><span>Terminal2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">champly @ champlydeiMac <span class="keyword">in</span> ~ [10:55:20]</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -it ebpf-for-mac bash</span></span><br><span class="line">root@76f664f7d01b:/# cd /root/code/session9</span><br><span class="line">root@76f664f7d01b:~/code/session9# ./main</span><br><span class="line">0</span><br><span class="line">root@76f664f7d01b:~/code/session9# ./main</span><br><span class="line">2</span><br><span class="line">root@76f664f7d01b:~/code/session9# ./main</span><br><span class="line">xxxxx 0xxxxx 1xxxxx 2xxxxx 3xxxxx 4xxxxx 5xxxxx 6xxxxx 799</span><br><span class="line">root@76f664f7d01b:~/code/session9# ./main</span><br><span class="line">xxxxx 0xxxxx 1xxxxx 2xxxxx 3xxxxx 4xxxxx 599</span><br></pre></td></tr></table></figure>

<p>可以看到可以查询到 <code>callbackTP</code> 函数调用的入参和返回值。</p>
<h3 id="libbpf"><a href="#libbpf" class="headerlink" title="libbpf"></a>libbpf</h3><p>通过这个 <code>libbpf</code> <a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/tree/main/code/session8/libbpf">代码</a> 可以实现对应 <code>BCC</code> <a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/tree/main/code/session8/bcc">代码</a> 相同的功能，<em>通过 <code>libbpf</code> 代码编译的结果不能在上面提到的容器环境中运行，可以把编译的二进制文件拷贝到对应的虚拟机中直接运行</em>。</p>
<p>这个项目也可以使用 <code>cilium</code> 的 <a target="_blank" rel="noopener" href="https://github.com/cilium/ebpf">ebpf</a> 库，通过 <code>Go</code> 语言进行开发用户态程序，这个是可以直接在容器环境中编译的。</p>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul>
<li>bpftrace 通常用在快速排查和定位系统上，它支持用单行脚本的方式来快速开发并执行一个 eBPF 程序。不过功能有限，不支持特别复杂的 eBPF 程序;</li>
<li>BCC 通常在开发复杂的 eBPF 程序中，其内置的各种小工具也是目前应用最为广泛的 eBPF 小程序。不过需要依赖 LLVM 和内核头文件才可以动态编译和加载 eBPF 程序;</li>
<li>libbpf 是从内核中抽离出来的标准库，用它开发的 eBPF 程序可以直接分发执行，这样就不需要每台机器都安装 LLVM 和内核头文件了。不过要求内核开启 BTF 特性。</li>
</ul>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="网络跟踪"><a href="#网络跟踪" class="headerlink" title="网络跟踪"></a>网络跟踪</h3><p>如果不知道怎么跟踪哪个函数调用，可以把所有的跟踪点都打印出来，下面的事例需要在虚拟机中实验，要不然打印不了调用栈:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">champly@ubuntu:~$ sudo bpftrace -e &#x27;tracepoint:net:* &#123; printf(&quot;%s(%d): %s %s\n&quot;, comm, pid, probe, kstack()); &#125;&#x27;</span><br><span class="line">Attaching 18 probes...</span><br><span class="line">swapper/5(0): tracepoint:net:napi_gro_receive_entry</span><br><span class="line">        napi_gro_receive+207</span><br><span class="line">        napi_gro_receive+207</span><br><span class="line">        e1000_clean_rx_irq+443</span><br><span class="line">        e1000_clean+621</span><br><span class="line">        __napi_poll+49</span><br><span class="line">        net_rx_action+575</span><br><span class="line">        __softirqentry_text_start+207</span><br><span class="line">        irq_exit_rcu+164</span><br><span class="line">        common_interrupt+138</span><br><span class="line">        asm_common_interrupt+30</span><br><span class="line">        native_safe_halt+14</span><br><span class="line">        acpi_idle_enter+91</span><br><span class="line">        cpuidle_enter_state+141</span><br><span class="line">        cpuidle_enter+46</span><br><span class="line">        call_cpuidle+35</span><br><span class="line">        do_idle+486</span><br><span class="line">        cpu_startup_entry+32</span><br><span class="line">        start_secondary+287</span><br><span class="line">        secondary_startup_64_no_verify+194</span><br></pre></td></tr></table></figure>

<p>如果需要排查丢包的问题，可以查询<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/htmldocs/networking/ch01s02.html">内核 SKB 文档</a>，可以看到内核释放 <code>SKB</code> 有两个地方:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/htmldocs/networking/API-kfree-skb.html">kfree_skb</a>：经常在网络异常丢包时调用;</li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/htmldocs/networking/API-consume-skb.html">consume_skb</a>：在正常网络连接完成的时候调用。</li>
</ul>
<p>以下是访问 <code>google.com</code> 获取到的结果:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">champly@ubuntu:~$ sudo bpftrace -e &#x27;kprobe:kfree_skb /comm==&quot;curl&quot;/ &#123;printf(&quot;kstack: %s\n&quot;, kstack);&#125;&#x27;</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">kstack:</span><br><span class="line">        kfree_skb+1</span><br><span class="line">        udpv6_destroy_sock+57</span><br><span class="line">        sk_common_release+34</span><br><span class="line">        udp_lib_close+9</span><br><span class="line">        inet_release+75</span><br><span class="line">        inet6_release+49</span><br><span class="line">        __sock_release+66</span><br><span class="line">        sock_close+21</span><br><span class="line">        __fput+159</span><br><span class="line">        ____fput+14</span><br><span class="line">        task_work_run+112</span><br><span class="line">        exit_to_user_mode_prepare+437</span><br><span class="line">        syscall_exit_to_user_mode+39</span><br><span class="line">        do_syscall_64+110</span><br><span class="line">        entry_SYSCALL_64_after_hwframe+68</span><br><span class="line"></span><br><span class="line">kstack:</span><br><span class="line">        kfree_skb+1</span><br><span class="line">        udpv6_destroy_sock+57</span><br><span class="line">        sk_common_release+34</span><br><span class="line">        udp_lib_close+9</span><br><span class="line">        inet_release+75</span><br><span class="line">        inet6_release+49</span><br><span class="line">        __sock_release+66</span><br><span class="line">        sock_close+21</span><br><span class="line">        __fput+159</span><br><span class="line">        ____fput+14</span><br><span class="line">        task_work_run+112</span><br><span class="line">        exit_to_user_mode_prepare+437</span><br><span class="line">        syscall_exit_to_user_mode+39</span><br><span class="line">        do_syscall_64+110</span><br><span class="line">        entry_SYSCALL_64_after_hwframe+68</span><br><span class="line"></span><br><span class="line">kstack:</span><br><span class="line">        kfree_skb+1</span><br><span class="line">        unix_release+29</span><br><span class="line">        __sock_release+66</span><br><span class="line">        sock_close+21</span><br><span class="line">        __fput+159</span><br><span class="line">        ____fput+14</span><br><span class="line">        task_work_run+112</span><br><span class="line">        exit_to_user_mode_prepare+437</span><br><span class="line">        syscall_exit_to_user_mode+39</span><br><span class="line">        do_syscall_64+110</span><br><span class="line">        entry_SYSCALL_64_after_hwframe+68</span><br><span class="line"></span><br><span class="line">kstack:</span><br><span class="line">        kfree_skb+1</span><br><span class="line">        __sys_connect_file+95</span><br><span class="line">        __sys_connect+160</span><br><span class="line">        __x64_sys_connect+26</span><br><span class="line">        do_syscall_64+97</span><br><span class="line">        entry_SYSCALL_64_after_hwframe+68</span><br><span class="line"></span><br><span class="line">kstack:</span><br><span class="line">        kfree_skb+1</span><br><span class="line">        __sys_connect_file+95</span><br><span class="line">        __sys_connect+160</span><br><span class="line">        __x64_sys_connect+26</span><br><span class="line">        do_syscall_64+97</span><br><span class="line">        entry_SYSCALL_64_after_hwframe+68</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>通过虚拟机环境的不同 <code>Docker</code> 容器来完成相关的步骤，具体的架构如下所示:</p>
<pre><code class="highlight mermaid">flowchart

client[Client: wrk] --&gt; LB[LB:172.17.0.4]
LB --&gt; http1[HTTP1:172.17.0.2]
LB --&gt; http2[HTTP2:172.17.0.3]</code></pre>

<h4 id="套接字优化"><a href="#套接字优化" class="headerlink" title="套接字优化"></a>套接字优化</h4><p><code>eBPF</code> 程序: <a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/blob/main/code/session12/sockops.bpf.c">sockops.bpf.c</a>、<a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/blob/main/code/session12/sockredir.bpf.c">sockredir.bpf.c</a>、<a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/blob/main/code/session12/sockops.h">sockops.h</a></p>
<p>具体实验步骤:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker run -itd --rm --name=http1 --hostname=http1 feisky/webserver</span><br><span class="line">33fb44488527c70424ff55793fdfc34d9004cde1e177b85a6e480f65dff04f2e</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker run -itd --rm --name=http2 --hostname=http2 feisky/webserver</span><br><span class="line">d6428353fd79c21446923f7c50f74dc35e9f9b6de60adefe372d9004f490e9b3</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker run -itd --rm --name=nginx nginx</span><br><span class="line">ed5f0acc0f9b74f5767164ef97c9826eca1586049230a2a8d50179ec6e492702</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ IP1=$(docker inspect http1 -f &#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;)</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ IP2=$(docker inspect http2 -f &#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;)</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ echo &quot;Webserver1&#x27;s IP: $IP1&quot;</span><br><span class="line">Webserver1&#x27;s IP: 172.17.0.2</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ echo &quot;Webserver2&#x27;s IP: $IP2&quot;</span><br><span class="line">Webserver2&#x27;s IP: 172.17.0.3</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ cat&gt;nginx.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">user  nginx;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">worker_processes  auto;</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&gt; error_log  /var/log/nginx/error.log notice;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">pid        /var/run/nginx.pid;</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&gt; events &#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    worker_connections  1024;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">&#125;</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&gt; http &#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">   include       /etc/nginx/mime.types;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">   default_type  application/octet-stream;</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&gt;     upstream webservers &#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">        server <span class="variable">$IP1</span>;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">        server <span class="variable">$IP2</span>;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    &#125;</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&gt;     server &#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">        listen 80;</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&gt;         location / &#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">            proxy_pass http://webservers;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">        &#125;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    &#125;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">&#125;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">EOF</span></span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker cp nginx.conf nginx:/etc/nginx/nginx.conf</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker exec nginx nginx -s reload</span><br><span class="line">2022/12/05 09:04:56 [notice] 37#37: signal process started</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ IP_LB=$(docker inspect nginx -f &#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;)</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker run -it --rm --name=client skandyla/wrk -c100 http://$IP_LB</span><br><span class="line">Running 10s test @ http://172.17.0.4</span><br><span class="line">  2 threads and 100 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     8.26ms    6.08ms  60.22ms   72.11%</span><br><span class="line">    Req/Sec     6.53k     0.92k    8.69k    68.00%</span><br><span class="line">  130064 requests in 10.02s, 20.47MB read</span><br><span class="line">Requests/sec:  12979.12</span><br><span class="line">Transfer/sec:      2.04MB</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ sudo bpftool prog load sockops.bpf.o /sys/fs/bpf/sockops type sockops pinmaps /sys/fs/bpf</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ sudo bpftool prog load sockredir.bpf.o /sys/fs/bpf/sockredir type sk_msg map name sock_ops_map pinned /sys/fs/bpf/sock_ops_map</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ sudo bpftool cgroup attach /sys/fs/cgroup/unified sock_ops pinned /sys/fs/bpf/sockops</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ sudo bpftool prog attach pinned /sys/fs/bpf/sockredir msg_verdict pinned /sys/fs/bpf/sock_ops_map</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker run -it --rm --name=client skandyla/wrk -c100 http://$IP_LB</span><br><span class="line">Running 10s test @ http://172.17.0.4</span><br><span class="line">  2 threads and 100 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     7.84ms    5.76ms  54.50ms   71.07%</span><br><span class="line">    Req/Sec     6.89k     0.87k    8.97k    63.50%</span><br><span class="line">  137069 requests in 10.02s, 21.57MB read</span><br><span class="line">Requests/sec:  13676.41</span><br><span class="line">Transfer/sec:      2.15MB</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ sudo bpftool prog detach pinned /sys/fs/bpf/sockredir msg_verdict pinned /sys/fs/bpf/sock_ops_map</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ sudo bpftool cgroup detach /sys/fs/cgroup/unified sock_ops name bpf_sockmap</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ sudo rm -rf /sys/fs/bpf/sockops /sys/fs/bpf/sockredir /sys/fs/bpf/sock_ops_map</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$ docker run -it --rm --name=client skandyla/wrk -c100 http://$IP_LB</span><br><span class="line">Running 10s test @ http://172.17.0.4</span><br><span class="line">  2 threads and 100 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     8.29ms    6.15ms  50.12ms   70.69%</span><br><span class="line">    Req/Sec     6.52k     0.93k    8.50k    64.00%</span><br><span class="line">  129810 requests in 10.03s, 20.43MB read</span><br><span class="line">Requests/sec:  12948.24</span><br><span class="line">Transfer/sec:      2.04MB</span><br><span class="line">champly@ubuntu:~/eBPF/example/session12$</span><br></pre></td></tr></table></figure>

<h4 id="XDP优化"><a href="#XDP优化" class="headerlink" title="XDP优化"></a>XDP优化</h4><p>就不要 <code>LB</code> 里面的 <code>Nginx</code> 服务，直接使用 <code>XDP</code> 程序完成转发，具体的实验代码在 <a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code/tree/main/code/session13">session13</a>。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">container:</span></span><br><span class="line">	docker run -itd --name=lb --privileged -v /sys/kernel/debug:/sys/kernel/debug alpine</span><br><span class="line"></span><br><span class="line"><span class="section">build:</span></span><br><span class="line">	clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I/usr/<span class="keyword">include</span>/x86_64-linux-gnu -I. -c xdp-proxy.bpf.c -o xdp-proxy.bpf.o</span><br><span class="line">	bpftool gen skeleton xdp-proxy.bpf.o &gt; xdp-proxy.skel.h</span><br><span class="line">	clang -g -O2 -Wall -I. -c xdp-proxy.c -o xdp-proxy.o</span><br><span class="line">	clang -Wall -O2 -g xdp-proxy.o -static -lbpf -lelf -lz -o xdp-proxy</span><br><span class="line"></span><br><span class="line"><span class="section">run:</span></span><br><span class="line">	<span class="comment"># 复制字节码到容器中</span></span><br><span class="line">	docker cp xdp-proxy.bpf.o lb:/</span><br><span class="line">	<span class="comment"># 在容器中安装iproute2命令行工具</span></span><br><span class="line">	docker exec -it lb apk add iproute2 --update</span><br><span class="line">	<span class="comment"># 在容器中挂载XDP程序到eth0网卡</span></span><br><span class="line">	docker exec -it lb ip link set dev eth0 xdpgeneric object xdp-proxy.bpf.o sec xdp</span><br></pre></td></tr></table></figure>

<hr>
<p>参考链接:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ebpf.io/what-is-ebpf/">https://ebpf.io/what-is-ebpf/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.brendangregg.com/ebpf.html">https://www.brendangregg.com/ebpf.html</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100104501">https://time.geekbang.org/column/intro/100104501</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/champly/ebpf-learn-code">https://github.com/champly/ebpf-learn-code</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ebpf.top/post/ebpf_learn_path/">https://www.ebpf.top/post/ebpf_learn_path&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc">https://github.com/iovisor/bcc</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/libbpf/libbpf">https://github.com/libbpf/libbpf</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/cilium/ebpf">https://github.com/cilium/ebpf</a></li>
<li><a target="_blank" rel="noopener" href="https://www.usenix.org/conference/lisa21/presentation/gregg-bpf">https://www.usenix.org/conference/lisa21/presentation/gregg-bpf</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/bpf/">https://docs.cilium.io/en/stable/bpf/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/iovisor/bpftrace">https://github.com/iovisor/bpftrace</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/htmldocs/networking/ch01s02.html">https://www.kernel.org/doc/htmldocs/networking/ch01s02.html</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/eBPF/" rel="tag"><i class="fa fa-tag"></i> eBPF</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/07/31/os/linux_task_scheduling/" rel="prev" title="Linux 进程管理(二)：任务调度">
                  <i class="fa fa-chevron-left"></i> Linux 进程管理(二)：任务调度
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/01/architecture/distributed-systems/" rel="next" title="分布式系统">
                  分布式系统 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">champly</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">80k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">1:13</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/champly" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.4.3/mermaid.min.js","integrity":"sha256-e0o3JYsdjqKajf9eOe22FhioYSz9WofRY4dLKo3F6do="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"http://example.com/2022/12/06/eBPF/getting-start-with-eBPF/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"champly","repo":"champly.github.io","client_id":"e73bf3d8d8c7947be9c2","client_secret":"25256fb151149009db7add5031c73f39a85f608c","admin_user":"champly","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"en","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"5e3587010acbfb694d9b718fbf3497ef"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>


  <script async src="/js/cursor/fireworks.js"></script>








<style>
	#bgCanvas {
		background-color: rgba(255,255,255) !important;
	}
</style>
<script type="text/javascript" size="150" alpha="0.6" zindex="-2" src="/js/bg/ribbon.min.js"></script>


</body>
</html>
